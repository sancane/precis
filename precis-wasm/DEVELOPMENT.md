# Development Guide for precis-wasm

## Prerequisites

1. **Rust 1.80+**: Required for PRECIS library
2. **wasm-pack**: WASM build tool

Install wasm-pack:
```bash
curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
```

Or via cargo:
```bash
cargo install wasm-pack
```

## Building

### For Web (Browser) - Recommended

```bash
cd precis-wasm
./build.sh
# or
npm run build
```

This script:
1. Builds WASM with `wasm-pack build --target web`
2. Copies manual TypeScript definitions with proper types
3. Updates `package.json` to use the manual `.d.ts` file

Generated files:
- `pkg/precis_wasm.js` - JavaScript bindings
- `pkg/precis_wasm_bg.wasm` - WebAssembly binary (249 KB, 104 KB gzipped)
- `pkg/precis_wasm.d.ts` - Auto-generated TypeScript definitions (any types)
- `pkg/precis_wasm_manual.d.ts` - Manual TypeScript definitions (string types) ✅
- `pkg/package.json` - NPM metadata (points to manual .d.ts)

### Raw Build (without TypeScript fixes)

```bash
wasm-pack build --target web --out-dir pkg
# or
npm run build:raw
```

Note: This will generate `any` types. Use `./build.sh` for proper TypeScript support.

### For Node.js

```bash
wasm-pack build --target nodejs --out-dir pkg-node
```

### For Bundlers (webpack, rollup, parcel)

```bash
wasm-pack build --target bundler --out-dir pkg-bundler
```

## Testing

### Run tests in browser

```bash
# Firefox (recommended)
wasm-pack test --headless --firefox

# Chrome
wasm-pack test --headless --chrome

# Safari
wasm-pack test --headless --safari
```

### Run specific test

```bash
wasm-pack test --headless --firefox -- test_nickname_enforce_basic
```

## Development Workflow

1. **Make changes** to `src/lib.rs`
2. **Check compilation**: `cargo check --package precis-wasm`
3. **Run clippy**: `cargo clippy --package precis-wasm -- -D warnings`
4. **Build WASM**: `wasm-pack build --target web`
5. **Test in browser**: Open `examples/web/index.html` in a local server

### Local Server

You need a local server to test due to CORS restrictions:

```bash
# Python 3
cd precis-wasm
python3 -m http.server 8000

# Or use 'serve' (npm install -g serve)
serve -s .

# Then open: http://localhost:8000/examples/web/
```

## Project Structure

```
precis-wasm/
├── Cargo.toml              # Rust package manifest
├── package.json            # NPM package manifest
├── README.md               # User documentation
├── DEVELOPMENT.md          # This file
├── .gitignore              # Ignore pkg/ and node_modules/
├── src/
│   └── lib.rs              # WASM API implementation
├── examples/
│   └── web/
│       └── index.html      # Browser demo
└── pkg/                    # Generated by wasm-pack (gitignored)
    ├── precis_wasm.js
    ├── precis_wasm_bg.wasm
    ├── precis_wasm.d.ts
    └── package.json
```

## Adding New Functions

To add a new WASM-exposed function:

1. Add the function to `src/lib.rs` with `#[wasm_bindgen]` attribute:

```rust
#[wasm_bindgen]
pub fn my_new_function(input: &str) -> Result<String, String> {
    // Implementation using PrecisFastInvocation
    Nickname::enforce(input)
        .map(|cow| cow.into_owned())
        .map_err(|e| format!("{}", e))
}
```

2. Add tests:

```rust
#[cfg(test)]
mod tests {
    use super::*;
    use wasm_bindgen_test::*;

    #[wasm_bindgen_test]
    fn test_my_new_function() {
        assert_eq!(my_new_function("input").unwrap(), "expected");
    }
}
```

3. Rebuild and test:

```bash
wasm-pack build --target web
wasm-pack test --headless --firefox
```

## Bundle Size Optimization

The `Cargo.toml` is already configured for minimal size:

```toml
[profile.release]
opt-level = "z"        # Optimize for size
lto = true             # Link-time optimization
codegen-units = 1      # Single codegen unit (better optimization)
panic = "abort"        # No unwinding (smaller binary)
strip = true           # Remove debug symbols
```

### Check bundle size

```bash
ls -lh pkg/precis_wasm_bg.wasm

# With wasm-opt (included in wasm-pack)
# Typical sizes:
# - Debug: ~2-3 MB
# - Release: ~250 KB
# - Gzipped: ~60-80 KB
```

## Publishing to NPM

```bash
# Build optimized release
wasm-pack build --target web --release

# Login to NPM (first time only)
npm login

# Publish
wasm-pack publish
```

## Troubleshooting

### Error: "wasm-bindgen not found"

```bash
cargo install wasm-bindgen-cli
```

### Error: "imports memory from '...' but it wasn't found"

This usually means the WASM target isn't properly configured. Make sure:
- `crate-type = ["cdylib", "rlib"]` in Cargo.toml
- Using correct wasm-pack target (web, nodejs, bundler)

### Tests don't run

Make sure you have a browser installed:
```bash
# On Ubuntu/Debian
sudo apt-get install firefox

# On macOS
# Firefox should be in /Applications/
```

### CORS errors in browser

You must use a local HTTP server, not `file://` protocol:

```bash
python3 -m http.server 8000
# Then open http://localhost:8000/examples/web/
```

## CI/CD Integration

Future work: Add GitHub Actions workflow to:
- Build WASM on every PR
- Run wasm-pack tests
- Publish to NPM on tag

Example workflow:
```yaml
- name: Install wasm-pack
  run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

- name: Build WASM
  run: cd precis-wasm && wasm-pack build --target web

- name: Test WASM
  run: cd precis-wasm && wasm-pack test --headless --firefox
```

## Resources

- [wasm-bindgen Book](https://rustwasm.github.io/wasm-bindgen/)
- [wasm-pack Documentation](https://rustwasm.github.io/wasm-pack/)
- [Rust and WebAssembly Book](https://rustwasm.github.io/book/)
